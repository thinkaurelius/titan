<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (version 1.7.0_21) on Mon Jul 29 05:50:18 EDT 2013 -->
<meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
<title>com.thinkaurelius.titan.diskstorage.locking.consistentkey (Titan-Site: Static Webpages and Docs 0.3.2 API)</title>
<meta name="date" content="2013-07-29">
<link rel="stylesheet" type="text/css" href="../../../../../../stylesheet.css" title="Style">
</head>
<body>
<script type="text/javascript"><!--
    if (location.href.indexOf('is-external=true') == -1) {
        parent.document.title="com.thinkaurelius.titan.diskstorage.locking.consistentkey (Titan-Site: Static Webpages and Docs 0.3.2 API)";
    }
//-->
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar_top">
<!--   -->
</a><a href="#skip-navbar_top" title="Skip navigation links"></a><a name="navbar_top_firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../../../overview-summary.html">Overview</a></li>
<li class="navBarCell1Rev">Package</li>
<li>Class</li>
<li><a href="package-use.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/package-summary.html">Prev Package</a></li>
<li><a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/transactional/package-summary.html">Next Package</a></li>
</ul>
<ul class="navList">
<li><a href="../../../../../../index.html?com/thinkaurelius/titan/diskstorage/locking/consistentkey/package-summary.html" target="_top">Frames</a></li>
<li><a href="package-summary.html" target="_top">No Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="../../../../../../allclasses-noframe.html">All Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip-navbar_top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<div class="header">
<h1 title="Package" class="title">Package&nbsp;com.thinkaurelius.titan.diskstorage.locking.consistentkey</h1>
<div class="docSummary">
<div class="block">Provides discretionary, distributed locking with key-column-value granularity for Titan's storage backends.</div>
</div>
<p>See:&nbsp;<a href="#package_description">Description</a></p>
</div>
<div class="contentContainer">
<ul class="blockList">
<li class="blockList">
<table class="packageSummary" border="0" cellpadding="3" cellspacing="0" summary="Interface Summary table, listing interfaces, and an explanation">
<caption><span>Interface Summary</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Interface</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/consistentkey/LocalLockMediatorProvider.html" title="interface in com.thinkaurelius.titan.diskstorage.locking.consistentkey">LocalLockMediatorProvider</a></td>
<td class="colLast">
<div class="block">Service provider interface for <a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/consistentkey/LocalLockMediators.html" title="enum in com.thinkaurelius.titan.diskstorage.locking.consistentkey"><code>LocalLockMediators</code></a>.</div>
</td>
</tr>
</tbody>
</table>
</li>
<li class="blockList">
<table class="packageSummary" border="0" cellpadding="3" cellspacing="0" summary="Class Summary table, listing classes, and an explanation">
<caption><span>Class Summary</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Class</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/consistentkey/ConsistentKeyLockConfiguration.html" title="class in com.thinkaurelius.titan.diskstorage.locking.consistentkey">ConsistentKeyLockConfiguration</a></td>
<td class="colLast">
<div class="block">A class that holds configuration specific to interprocess locking.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/consistentkey/ConsistentKeyLockStore.html" title="class in com.thinkaurelius.titan.diskstorage.locking.consistentkey">ConsistentKeyLockStore</a></td>
<td class="colLast">
<div class="block">A wrapper that adds locking support to a <a href="../../../../../../com/thinkaurelius/titan/diskstorage/keycolumnvalue/KeyColumnValueStore.html" title="interface in com.thinkaurelius.titan.diskstorage.keycolumnvalue"><code>KeyColumnValueStore</code></a> by
 overridding
 <a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/consistentkey/ConsistentKeyLockStore.html#acquireLock(com.thinkaurelius.titan.diskstorage.StaticBuffer, com.thinkaurelius.titan.diskstorage.StaticBuffer, com.thinkaurelius.titan.diskstorage.StaticBuffer, com.thinkaurelius.titan.diskstorage.keycolumnvalue.StoreTransaction)"><code>acquireLock()</code></a> and <a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/consistentkey/ConsistentKeyLockStore.html#mutate(com.thinkaurelius.titan.diskstorage.StaticBuffer, java.util.List, java.util.List, com.thinkaurelius.titan.diskstorage.keycolumnvalue.StoreTransaction)"><code>mutate()</code></a>.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/consistentkey/ConsistentKeyLockTransaction.html" title="class in com.thinkaurelius.titan.diskstorage.locking.consistentkey">ConsistentKeyLockTransaction</a></td>
<td class="colLast">
<div class="block">A <a href="../../../../../../com/thinkaurelius/titan/diskstorage/keycolumnvalue/StoreTransaction.html" title="interface in com.thinkaurelius.titan.diskstorage.keycolumnvalue"><code>StoreTransaction</code></a> that supports locking via
 <a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/consistentkey/LocalLockMediator.html" title="class in com.thinkaurelius.titan.diskstorage.locking.consistentkey"><code>LocalLockMediator</code></a> and writing and reading lock records in a
 <a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/consistentkey/ConsistentKeyLockStore.html" title="class in com.thinkaurelius.titan.diskstorage.locking.consistentkey"><code>ConsistentKeyLockStore</code></a>.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/consistentkey/LocalLockMediator.html" title="class in com.thinkaurelius.titan.diskstorage.locking.consistentkey">LocalLockMediator</a></td>
<td class="colLast">
<div class="block">This class resolves lock contention between two transactions on the same JVM.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/consistentkey/LockClaim.html" title="class in com.thinkaurelius.titan.diskstorage.locking.consistentkey">LockClaim</a></td>
<td class="colLast">
<div class="block">An attempted lock.</div>
</td>
</tr>
</tbody>
</table>
</li>
<li class="blockList">
<table class="packageSummary" border="0" cellpadding="3" cellspacing="0" summary="Enum Summary table, listing enums, and an explanation">
<caption><span>Enum Summary</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Enum</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/consistentkey/LocalLockMediators.html" title="enum in com.thinkaurelius.titan.diskstorage.locking.consistentkey">LocalLockMediators</a></td>
<td class="colLast">
<div class="block">A singleton maintaining a globally unique map of <a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/consistentkey/LocalLockMediator.html" title="class in com.thinkaurelius.titan.diskstorage.locking.consistentkey"><code>LocalLockMediator</code></a>
 instances.</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<a name="package_description">
<!--   -->
</a>
<h2 title="Package com.thinkaurelius.titan.diskstorage.locking.consistentkey Description">Package com.thinkaurelius.titan.diskstorage.locking.consistentkey Description</h2>
<div class="block">Provides discretionary, distributed locking with key-column-value granularity for Titan's storage backends.  The package enforces locking at two levels:
 
 <ul>
 <li>Between threads in the same process via <a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/consistentkey/LocalLockMediator.html" title="class in com.thinkaurelius.titan.diskstorage.locking.consistentkey"><code>LocalLockMediator</code></a>.
 <li>Between processes on the same or different hosts via reads and writes to a <a href="../../../../../../com/thinkaurelius/titan/diskstorage/keycolumnvalue/KeyColumnValueStore.html" title="interface in com.thinkaurelius.titan.diskstorage.keycolumnvalue"><code>KeyColumnValueStore</code></a> reserved for locking.
 </ul>
 
 <h2>Using locking</h2>
 
 There are three methods involved in using locking.
 
 <ul>
 <li><code>KeyColumnValueStore's acquireLock()</code>
 <li><code>KeyColumnValueStore's mutate()</code>
 <li><a href="../../../../../../com/thinkaurelius/titan/diskstorage/TransactionHandle.html#commit()"><code>StoreTransaction's commit()</code></a> (or <code>rollback()</code>)
 </ul>
 
 To claim locks, first call <code>acquireLock()</code> on the keys, columns, and expected values.
 To claim multiple locks, call <code>acquireLock()</code> multiple times.
 <code>acquireLock()</code> may throw <a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/LockingException.html" title="interface in com.thinkaurelius.titan.diskstorage.locking"><code>LockingException</code></a>
 if it detects a failure to acquire the lock.
 However, in order to permit optimistic locking,
 <code>acquireLock()</code> is not required to detect failures and throw <code>LockingException</code>.
 
 <p>
 
 To guarantee that all <code>acquireLock()</code> calls succeeded in obtaining their locks, call <code>mutate()</code>.
 The first call to <code>mutate()</code> automatically checks the result of all previous <code>acquireLock()</code> calls before mutating data.
 If any of the locks failed, then {code mutate()} will throw a <code>LockingException</code>.
 
 <p>
 
 After the first call to <code>mutate()</code>, no further calls to <code>acquireLock()</code> are permitted on the transaction.
 Take all locks required by a transaction before mutating data with that transaction.
 
 <p>

 To release a transaction's locks, call <code>commit()</code> (or <code>rollback()</code>) on the transaction.
 
 <h2>Locking internals overview</h2>
 
 <h3>Enforcement within a process</h3>
 
 Lock contention between transactions in a process is arbitrated by the <code>LocalLockMediator</code> class.  Each <a href="../../../../../../com/thinkaurelius/titan/diskstorage/keycolumnvalue/KeyColumnValueStore.html" title="interface in com.thinkaurelius.titan.diskstorage.keycolumnvalue"><code>KeyColumnValueStore</code></a> with lockable data has a single <code>LocalLockMediator</code> responsible for ensuring that at most one transaction in the JVM holds the lock on any <code>(key, column)</code> pair at a time.
 
 <p>
 
 Acquiring a lock from a <code>LocalLockMediator</code> implies that no other transactions in the JVM hold that lock.  However, when Titan is running in a cluster, there may be other Titan processes with transactions that <code>LocalLockMediator</code> can't track.  This is addressed in the next section.
 
 <h3>Enforcement between processes</h3>

 Titan manages remote contention using a separate <code>KeyColumnValueStore</code> called the <code>lockStore</code> containing only locking protocol records (no graph data are stored in the <code>lockStore</code>).  The details are implementation-dependent, but for Cassandra and HBase, each column family has its own <code>lockStore</code>.
 
 <p>

 After Titan successfully acquires a local lock from a <code>LocalLockMediator</code>, it writes a single value to the .
 
 <ul>
 <li> key: concatenation of (size of the lock claim key), (lock claim key), (lock claim column)</li>
 <li> column: concatenation of (# of nanoseconds since UNIX Epoch), (requestor id)</li>
 <li> value: expected value supplied by the user in <code>acquireLock()</code></li>
 </ul>

 In the listing above, "(requestor id)" is an arbitrary sequence of bytes uniquely identifying the Cassandra process within the Titan cluster.  The value and length doesn't matter, so long as its unique.
 This write must complete in less than <a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/consistentkey/ConsistentKeyLockStore.html#getLockWaitMS()"><code>getLockWaitMS()</code></a>.  If takes longer, then the write is deleted (if possible) and the lock attempt fails.
 
 <p>
 
 The transaction has now staked a lock claim in the globally-visible <code>lockStore</code>.  After <code>getLockWaitMS()</code> elapses since writing the claim, the transaction may determine whether or not the lock attempt succeeded by reading and examining the columns on the .  If the column representing the transaction's lock claim is the first one in bytewise-order on the row, then its lock timestamp is the earliest, and it holds the lock.  The implementation also has a configurable lock expiration time, <a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/consistentkey/ConsistentKeyLockStore.html#getLockExpireMS()"><code>ConsistentKeyLockStore.getLockExpireMS()</code></a>, which is the maximum lifetime of a lock.  Columns in <code>lockStore</code> with timestamps older than this timeout are considered invalid and ignored.
 
 <p>
 
 Unlocking involves deleting the lock claim column from the <code>lockStore</code> and releasing the lock in <code>LocalLockMediator</code>.</div>
</div>
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar_bottom">
<!--   -->
</a><a href="#skip-navbar_bottom" title="Skip navigation links"></a><a name="navbar_bottom_firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../../../overview-summary.html">Overview</a></li>
<li class="navBarCell1Rev">Package</li>
<li>Class</li>
<li><a href="package-use.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/package-summary.html">Prev Package</a></li>
<li><a href="../../../../../../com/thinkaurelius/titan/diskstorage/locking/transactional/package-summary.html">Next Package</a></li>
</ul>
<ul class="navList">
<li><a href="../../../../../../index.html?com/thinkaurelius/titan/diskstorage/locking/consistentkey/package-summary.html" target="_top">Frames</a></li>
<li><a href="package-summary.html" target="_top">No Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="../../../../../../allclasses-noframe.html">All Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip-navbar_bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
<p class="legalCopy"><small>Copyright &#169; 2012&#x2013;2013. All rights reserved.</small></p>
</body>
</html>
